# Slide Puzzle Master - 仕様書

> Version 1.0 | Base Mini App

## 目次

1. [アプリ概要](#1-アプリ概要)
2. [機能一覧](#2-機能一覧)
3. [技術構成](#3-技術構成)
4. [プロジェクト構成](#4-プロジェクト構成)
5. [動作フロー](#5-動作フロー)
6. [スマートコントラクト仕様](#6-スマートコントラクト仕様)
7. [フロントエンド仕様](#7-フロントエンド仕様)
8. [画面構成](#8-画面構成)
9. [将来の拡張予定](#9-将来の拡張予定)
10. [注意事項・制限](#10-注意事項制限)

---

## 1. アプリ概要

### 1.1 アプリの目的

Slide Puzzle Master は、Base ブロックチェーン上で動作するスライドパズルゲームです。プレイヤーはパズルを解き、そのクリアタイムをNFT（デジタル証明書）としてブロックチェーン上に記録できます。

### 1.2 コンセプト

| コンセプト | 説明 |
|-----------|------|
| **Play to Prove** | 金銭的報酬ではなく「記録を証明する」ことに価値を置く |
| **シンプル & アクセシブル** | 誰でも遊べるカジュアルなゲーム性 |
| **ソーシャル連携** | Farcaster（分散型SNS）でスコアを共有し競い合う |

### 1.3 ターゲットユーザー

- Farcaster / Warpcast ユーザー
- Base ブロックチェーンに興味のある人
- カジュアルにNFTを体験したい人

---

## 2. 機能一覧

### 2.1 ゲーム機能

#### 難易度設定

| 難易度 | グリッドサイズ | ピース数 | 目安時間 |
|--------|---------------|----------|----------|
| Easy | 3×3 | 8 | 数十秒〜数分 |
| Normal | 4×4 | 15 | 数分〜十数分 |
| Hard | 5×5 | 24 | 十数分〜 |

#### パズルの仕様

- **シャッフル方式**: 完成状態から実際のスライド操作を300回シミュレートすることで、必ず解ける配置を生成
- **タイマー**: 最初のピース移動でスタート、完成でストップ（ミリ秒単位）
- **移動回数**: カウント表示（NFTには記録されない）

### 2.2 NFTミント機能

パズルをクリアすると、その記録をNFT（Non-Fungible Token）として発行できます。

#### NFTに記録される情報

- プレイヤーのウォレットアドレス
- 難易度（Easy / Normal / Hard）
- クリアタイム（ミリ秒単位）
- ミント日時

#### NFT画像（オンチェーンSVG）

NFTの画像はブロックチェーン上で動的に生成されます（外部サーバー不要）。

| 難易度 | 背景色 |
|--------|--------|
| Easy | 緑系 (#2d5a27) |
| Normal | 青系 (#1e3a5f) |
| Hard | 紫系 (#5c2d5c) |

### 2.3 リーダーボード機能

- 難易度別にトップ10を表示
- NFTをミントした人のみがランキングに登録される
- クリアタイムが短い順にランク付け

### 2.4 Farcaster連携

NFTミント後、Farcaster（分散型SNS）に結果をCast（投稿）できます。

---

## 3. 技術構成

### 3.1 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    Frontend (Next.js)                        │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌───────────────┐   │
│  │ Puzzle   │ │ Timer    │ │ Mint     │ │ Leaderboard   │   │
│  │ Component│ │ Component│ │ Button   │ │ Component     │   │
│  └──────────┘ └──────────┘ └──────────┘ └───────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │            MiniKit / Wagmi (Wallet Integration)       │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ JSON-RPC
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  Base Blockchain (Ethereum L2)               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              SlidePuzzleNFT Contract                  │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌────────────────┐  │   │
│  │  │ mint()      │ │ Leaderboard │ │ On-chain SVG   │  │   │
│  │  │ ERC-721     │ │ Storage     │ │ Generation     │  │   │
│  │  └─────────────┘ └─────────────┘ └────────────────┘  │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 技術スタック

| レイヤー | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| **Frontend** | Next.js | 14.x | Reactフレームワーク |
| | React | 18.x | UIライブラリ |
| | TypeScript | 5.x | 型安全なJavaScript |
| | Tailwind CSS | 3.x | スタイリング |
| **Web3** | MiniKit | latest | Base Mini App SDK |
| | Wagmi | 2.x | React用Web3フック |
| | Viem | 2.x | Ethereumクライアント |
| **Smart Contract** | Solidity | 0.8.20 | コントラクト言語 |
| | OpenZeppelin | 5.x | セキュアなコントラクトライブラリ |
| **Blockchain** | Base | - | Ethereum L2 |
| **Hosting** | Vercel | - | フロントエンドホスティング |

---

## 4. プロジェクト構成

### 4.1 ディレクトリ構造

```
slide-puzzle-miniapp/
├── app/                          # Next.js App Router
│   ├── globals.css               # グローバルスタイル
│   ├── layout.tsx                # ルートレイアウト
│   └── page.tsx                  # メインページ
│
├── components/                   # Reactコンポーネント
│   ├── SlidePuzzle.tsx           # パズル本体
│   ├── Timer.tsx                 # タイマー表示
│   ├── DifficultySelector.tsx    # 難易度選択UI
│   ├── Leaderboard.tsx           # ランキング表示
│   ├── MintButton.tsx            # NFTミントボタン
│   └── ShareButton.tsx           # Farcaster共有ボタン
│
├── lib/                          # ユーティリティ・設定
│   ├── contract.ts               # コントラクトABI・アドレス
│   └── puzzle.ts                 # パズルロジック
│
├── providers/                    # Reactプロバイダー
│   └── Providers.tsx             # Wagmi/ReactQuery設定
│
├── contracts/                    # スマートコントラクト
│   └── SlidePuzzleNFT.sol        # NFTコントラクト
│
├── public/                       # 静的ファイル
│   └── .well-known/              # Farcaster manifest用
│
├── package.json                  # 依存関係
├── tailwind.config.js            # Tailwind設定
├── tsconfig.json                 # TypeScript設定
└── next.config.js                # Next.js設定
```

### 4.2 各ファイル・フォルダの詳細

#### `/app` - Next.js App Router

| ファイル | 説明 |
|---------|------|
| `globals.css` | Tailwind CSSのインポート、カスタムCSSクラス（`.puzzle-tile`, `.btn-primary`等）、フォント設定 |
| `layout.tsx` | HTMLの基本構造、メタデータ（OGP）、Providersのラップ |
| `page.tsx` | ゲームのメイン画面。状態管理（難易度、ゲーム状態、タイム）とコンポーネントの配置 |

#### `/components` - UIコンポーネント

| ファイル | 説明 | Props |
|---------|------|-------|
| `SlidePuzzle.tsx` | パズルボードの表示と操作。タイルのクリックイベント、完成判定 | `difficulty`, `onStart`, `onComplete`, `isPlaying` |
| `Timer.tsx` | 経過時間の表示（10ms間隔で更新） | `isRunning`, `onTimeUpdate`, `reset` |
| `DifficultySelector.tsx` | Easy/Normal/Hardボタンの表示 | `selected`, `onChange`, `disabled` |
| `Leaderboard.tsx` | トップ10ランキングの表示。コントラクトから読み取り | `difficulty` |
| `MintButton.tsx` | ウォレット接続とNFTミント処理 | `difficulty`, `timeInMs`, `onMintSuccess` |
| `ShareButton.tsx` | FarcasterへのCast投稿 | `difficulty`, `timeInMs` |

#### `/lib` - ロジック・設定

| ファイル | 説明 |
|---------|------|
| `contract.ts` | コントラクトアドレス、ABI定義、難易度Enum、設定オブジェクト |
| `puzzle.ts` | パズルロジック（シャッフル、移動判定、完成判定、時間フォーマット） |

#### `/providers` - グローバル設定

| ファイル | 説明 |
|---------|------|
| `Providers.tsx` | Wagmi設定（チェーン、コネクター）、ReactQueryクライアント |

#### `/contracts` - スマートコントラクト

| ファイル | 説明 |
|---------|------|
| `SlidePuzzleNFT.sol` | ERC-721 NFTコントラクト。ミント、リーダーボード、オンチェーンSVG生成 |

---

## 5. 動作フロー

### 5.1 ゲームプレイフロー

```
┌─────────────────────────────────────────────────────────────┐
│                      ユーザーアクション                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 1. 難易度選択                                                │
│    DifficultySelector で Easy/Normal/Hard を選択            │
│    → page.tsx の state 更新                                 │
│    → SlidePuzzle が新しいグリッドサイズでリセット            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. パズル表示                                                │
│    SlidePuzzle.tsx                                          │
│    - shuffleBoard() で必ず解ける配置を生成                   │
│    - グリッドサイズに応じたタイルを表示                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. ゲーム開始（最初のタイル移動）                             │
│    - handleTileClick() で移動可能か判定                      │
│    - canMove() → getNeighbors() で隣接チェック              │
│    - onStart() コールバック → Timer 開始                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. パズル操作                                                │
│    - タイルクリック → moveTile() でスワップ                  │
│    - 10ms間隔で Timer 更新                                   │
│    - 移動回数カウント                                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 5. 完成判定                                                  │
│    - isSolved() で [1,2,3,...,n,0] の並びか確認             │
│    - true → onComplete() → Timer 停止、finalTime 記録      │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 NFTミントフロー

```
┌─────────────────────────────────────────────────────────────┐
│ 1. ウォレット接続                                            │
│    MintButton.tsx                                           │
│    - useAccount() で接続状態確認                             │
│    - 未接続 → connect() で Coinbase Wallet 接続             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. ミントトランザクション作成                                 │
│    - useWriteContract() で mint(difficulty, timeInMs) 呼出  │
│    - ウォレットで署名リクエスト表示                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. トランザクション送信                                       │
│    Frontend → JSON-RPC → Base Network                       │
│    - ガス代支払い（ETH）                                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. コントラクト実行                                          │
│    SlidePuzzleNFT.mint()                                    │
│    - _safeMint() で NFT 発行                                │
│    - puzzleRecords[tokenId] に記録保存                      │
│    - _updateLeaderboard() でランキング更新                  │
│    - PuzzleSolved イベント発行                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 5. 完了処理                                                  │
│    - useWaitForTransactionReceipt() で確認待ち              │
│    - isConfirmed → 成功UI表示                               │
│    - Leaderboard.refetch() でランキング更新                 │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 リーダーボード更新フロー

```
┌─────────────────────────────────────────────────────────────┐
│ コントラクト内部: _updateLeaderboard()                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 1. 挿入位置の探索                                            │
│    - leaderboards[difficulty] を先頭から走査                │
│    - timeInMs < board[i].timeInMs となる位置を探す          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. ランクイン判定                                            │
│    - 挿入位置 >= MAX_LEADERBOARD_SIZE(10) → ランク外で終了  │
│    - 挿入位置 < 10 → ランクイン処理へ                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. 配列操作                                                  │
│    - 配列長 < 10 → push() で拡張                            │
│    - 挿入位置以降を1つ後ろにシフト                           │
│    - 挿入位置に新エントリを配置                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. イベント発行                                              │
│    LeaderboardUpdated(difficulty, player, timeInMs, rank)   │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. スマートコントラクト仕様

### 6.1 コントラクト概要

| 項目 | 値 |
|------|-----|
| コントラクト名 | SlidePuzzleNFT |
| 規格 | ERC-721 (OpenZeppelin) |
| Solidity | ^0.8.20 |
| ライセンス | MIT |

### 6.2 データ構造

```solidity
// 難易度Enum
enum Difficulty {
    Easy,      // 0: 3x3
    Normal,    // 1: 4x4
    Hard,      // 2: 5x5
    VeryHard,  // 3: 6x6 (Phase 2)
    Hell       // 4: 7x7 (Phase 2)
}

// NFTごとの記録
struct PuzzleRecord {
    address player;           // プレイヤーアドレス
    Difficulty difficulty;    // 難易度
    uint256 timeInMs;         // クリアタイム（ミリ秒）
    uint256 timestamp;        // ミント日時（UNIXタイムスタンプ）
}

// リーダーボードエントリ
struct LeaderboardEntry {
    address player;           // プレイヤーアドレス
    uint256 timeInMs;         // クリアタイム
    uint256 tokenId;          // NFTのトークンID
}
```

### 6.3 ストレージ

| 変数名 | 型 | 説明 |
|--------|-----|------|
| `_nextTokenId` | `uint256` | 次に発行するトークンID |
| `puzzleRecords` | `mapping(uint256 => PuzzleRecord)` | トークンID → 記録 |
| `leaderboards` | `mapping(Difficulty => LeaderboardEntry[])` | 難易度 → ランキング配列 |
| `MAX_LEADERBOARD_SIZE` | `uint256` | 10（定数） |

### 6.4 関数一覧

#### 外部関数（ユーザーが呼び出す）

| 関数 | 引数 | 戻り値 | 説明 |
|------|------|--------|------|
| `mint` | `difficulty`, `timeInMs` | `tokenId` | NFTをミントしリーダーボードを更新 |
| `getLeaderboard` | `difficulty` | `LeaderboardEntry[]` | 指定難易度のランキングを取得 |
| `tokenURI` | `tokenId` | `string` | NFTメタデータ（Base64エンコードJSON + SVG） |
| `totalSupply` | - | `uint256` | 発行済NFT総数 |

#### 内部関数

| 関数 | 説明 |
|------|------|
| `_updateLeaderboard` | リーダーボードを更新（タイム順ソート挿入） |
| `_getDifficultyName` | Enum → 文字列変換 |
| `_getGridSize` | Enum → "3x3"等の文字列変換 |
| `_formatTime` | ミリ秒 → "M:SS.mmm"形式変換 |
| `_generateSVG` | NFT画像のSVGを生成 |
| `_getBackgroundColor` | 難易度に応じた背景色を返す |
| `_generatePuzzleGrid` | パズルグリッドのSVG要素を生成 |

### 6.5 イベント

```solidity
event PuzzleSolved(
    address indexed player,
    uint256 indexed tokenId,
    Difficulty difficulty,
    uint256 timeInMs
);

event LeaderboardUpdated(
    Difficulty indexed difficulty,
    address indexed player,
    uint256 timeInMs,
    uint256 rank
);
```

### 6.6 NFTメタデータ形式

```json
{
  "name": "Slide Puzzle Master #0",
  "description": "Proof of solving a 3x3 slide puzzle in 0:45.123",
  "attributes": [
    { "trait_type": "Difficulty", "value": "Easy" },
    { "trait_type": "Grid Size", "value": "3x3" },
    { "trait_type": "Time (ms)", "value": 45123 },
    { "trait_type": "Time", "value": "0:45.123" }
  ],
  "image": "data:image/svg+xml;base64,..."
}
```

---

## 7. フロントエンド仕様

### 7.1 状態管理（page.tsx）

| State | 型 | 初期値 | 説明 |
|-------|-----|--------|------|
| `difficulty` | `Difficulty` | `Easy` | 選択中の難易度 |
| `gameState` | `'idle' \| 'playing' \| 'completed'` | `'idle'` | ゲーム状態 |
| `currentTime` | `number` | `0` | 現在の経過時間（ms） |
| `finalTime` | `number` | `0` | クリア時の確定タイム |
| `resetTrigger` | `number` | `0` | パズルリセット用カウンター |
| `hasMinted` | `boolean` | `false` | NFTミント完了フラグ |

### 7.2 パズルロジック（lib/puzzle.ts）

#### シャッフルアルゴリズム

```typescript
function shuffleBoard(gridSize: number, moves: number = 300): Board {
  // 1. 完成状態 [1,2,3,...,n-1,0] を作成
  // 2. 300回ランダムに隣接タイルと空白をスワップ
  // 3. 直前の移動を戻さないようフィルタ（往復防止）
}
```

#### 移動判定

```typescript
function canMove(board: Board, tileIndex: number): boolean {
  // 空白タイルの隣接マスかどうかを判定
  // 上下左右の4方向をチェック（端の処理あり）
}
```

#### 完成判定

```typescript
function isSolved(board: Board): boolean {
  // [1,2,3,...,n-1,0] の並びと一致するか確認
}
```

### 7.3 Web3フック（Wagmi）

| フック | 用途 |
|--------|------|
| `useAccount` | 接続中のウォレットアドレス取得 |
| `useConnect` | ウォレット接続処理 |
| `useWriteContract` | コントラクトへの書き込みトランザクション |
| `useWaitForTransactionReceipt` | トランザクション確認待ち |
| `useReadContract` | コントラクトからの読み取り |

### 7.4 スタイリング

#### カスタムCSSクラス（globals.css）

| クラス | 説明 |
|--------|------|
| `.puzzle-tile` | パズルタイルの基本スタイル |
| `.difficulty-badge` | 難易度ボタン（.easy, .normal, .hard） |
| `.timer-display` | タイマー表示（大きなフォント、グロー効果） |
| `.btn-primary` | メインアクションボタン（緑、グロー） |
| `.btn-secondary` | サブアクションボタン（枠線のみ） |
| `.game-card` | カード型コンテナ |
| `.leaderboard-row` | ランキング行 |

#### カラーパレット

| 変数 | 値 | 用途 |
|------|-----|------|
| `puzzle-bg` | #0a0a0f | 背景 |
| `puzzle-card` | #14141f | カード背景 |
| `puzzle-border` | #2a2a3a | 枠線 |
| `puzzle-accent` | #00ff88 | アクセントカラー |
| `puzzle-easy` | #2d5a27 | Easy難易度 |
| `puzzle-normal` | #1e3a5f | Normal難易度 |
| `puzzle-hard` | #5c2d5c | Hard難易度 |

---

## 8. 画面構成

### 8.1 メイン画面レイアウト

```
┌────────────────────────────────────┐
│          SLIDE PUZZLE              │  ← タイトル
│        Solve • Mint • Compete      │
├────────────────────────────────────┤
│   [Easy]  [Normal]  [Hard]         │  ← 難易度選択
├────────────────────────────────────┤
│            0:00.000                │  ← タイマー
├────────────────────────────────────┤
│  ┌─────────────────────────────┐   │
│  │  ┌───┬───┬───┐              │   │
│  │  │ 1 │ 2 │ 3 │              │   │
│  │  ├───┼───┼───┤              │   │  ← パズルエリア
│  │  │ 4 │ 5 │ 6 │              │   │
│  │  ├───┼───┼───┤              │   │
│  │  │ 7 │ 8 │   │              │   │
│  │  └───┴───┴───┘              │   │
│  │        Moves: 0              │   │
│  │     [Reset Puzzle]           │   │
│  └─────────────────────────────┘   │
├────────────────────────────────────┤
│         🏆 Leaderboard             │
│  ┌────────────────────────────┐    │
│  │ 1. 0x1234...abcd  0:32.456 │    │  ← リーダーボード
│  │ 2. 0x5678...efgh  0:45.789 │    │
│  │ ...                        │    │
│  └────────────────────────────┘    │
├────────────────────────────────────┤
│      Built on Base with MiniKit    │  ← フッター
└────────────────────────────────────┘
```

### 8.2 クリア後の画面

```
├────────────────────────────────────┤
│  ┌─────────────────────────────┐   │
│  │    🎉 PUZZLE SOLVED! 🎉     │   │
│  └─────────────────────────────┘   │
├────────────────────────────────────┤
│  ┌─────────────────────────────┐   │
│  │      Your Record            │   │
│  │         Easy                │   │  ← 記録表示
│  │       0:45.123              │   │
│  └─────────────────────────────┘   │
│                                    │
│  [🎨 Mint NFT & Join Leaderboard]  │  ← ミントボタン
│  [📢 Share on Farcaster]           │  ← シェアボタン
│  [🔄 Play Again]                   │  ← リプレイボタン
├────────────────────────────────────┤
```

---

## 9. 将来の拡張予定（Phase 2）

| 機能 | 説明 |
|------|------|
| Very Hard (6×6) | 35ピースの超難問 |
| Hell (7×7) | 48ピースの地獄級 |
| カスタム画像パズル | 任意の画像をパズルにする機能 |
| デイリーチャレンジ | 日替わりのシード固定パズル |
| マルチプレイ | リアルタイム対戦 |

---

## 10. 注意事項・制限

### 10.1 技術的制限

| 項目 | 説明 |
|------|------|
| **不正対策なし** | クリアタイムの検証機能は実装されていません。悪意あるユーザーが偽のタイムを送信することは技術的に可能です。 |
| **オフチェーン計測** | タイマーはフロントエンド（ブラウザ）で計測しています。ブロックチェーン上での検証は行っていません。 |

### 10.2 利用時の注意

| 項目 | 説明 |
|------|------|
| **ガス代** | NFTミント時にはBaseネットワークのガス代（手数料）がかかります。通常は数セント程度です。 |
| **ウォレット必須** | NFTミントにはCoinbase Walletなどのウォレットが必要です。 |
| **ネットワーク** | Base Mainnet または Base Sepolia（テストネット）で動作します。 |

### 10.3 セキュリティ

| 項目 | 対策 |
|------|------|
| **コントラクト** | OpenZeppelin の監査済みライブラリを使用 |
| **秘密鍵** | フロントエンドでは秘密鍵を扱わない（ウォレット経由） |
| **入力検証** | コントラクト側で difficulty の範囲チェック（Enum） |
